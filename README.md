# Мини-CRM распределения лидов

## Запуск проекта

```bash
pip install -r requirements.txt
uvicorn app.main:app --reload
```

API будет доступен по адресу `http://localhost:8000`, документация — `http://localhost:8000/docs`

## Модель данных

Система состоит из следующих сущностей:

1. **Operator** (Оператор) — сотрудник, обрабатывающий обращения
   - Имеет статус активности (`is_active`)
   - Имеет лимит нагрузки (`load_limit`)

2. **Source** (Источник) — канал поступления обращений (бот, мессенджер и т.д.)

3. **SourceOperatorWeight** — связь между источником и оператором с весом распределения
   - Определяет, какие операторы работают с каким источником
   - Содержит числовой вес для распределения трафика

4. **Lead** (Лид) — клиент/потенциальный клиент
   - Идентифицируется по `external_id`, `phone` или `email`
   - Один лид может иметь несколько обращений из разных источников

5. **Contact** (Обращение) — конкретный факт обращения лида через источник
   - Связан с лидом, источником и оператором (если назначен)
   - Имеет статус активности (`is_active`)

**Связи:**
- Operator ↔ SourceOperatorWeight ↔ Source (многие ко многим с весом)
- Lead → Contact (один ко многим)
- Source → Contact (один ко многим)
- Operator → Contact (один ко многим, опционально)

## Алгоритм распределения

### Определение лида

При создании обращения система ищет существующего лида по приоритету:
1. По `external_id` (если указан)
2. По `phone` (если указан)
3. По `email` (если указан)

Если лид не найден, создаётся новый. Таким образом, обращения с одинаковым `external_id`, `phone` или `email` относятся к одному лиду.

### Учёт весов операторов

Для каждого источника у операторов заданы числовые веса (например, 10, 20, 50).

Выбор оператора происходит методом **взвешенной случайной выборки**:
- Вычисляется сумма весов всех доступных операторов для источника
- Вероятность выбора каждого оператора = `вес_оператора / сумма_весов`
- Выполняется случайный выбор с учётом этих вероятностей

Пример: оператор1 с весом 10 и оператор2 с весом 30 → примерно 25% и 75% трафика соответственно.

### Учёт лимитов нагрузки

**Нагрузка** определяется как количество активных обращений (`is_active = True`), назначенных оператору.

Перед распределением система:
1. Находит всех операторов, назначенных на источник
2. Фильтрует только активных операторов (`is_active = True`)
3. Проверяет, что текущая нагрузка оператора меньше его лимита (`текущая_нагрузка < load_limit`)
4. Выбирает оператора только из доступных (прошедших фильтры)

После выбора оператора система повторно проверяет лимит (для защиты от race conditions).

### Отсутствие подходящих операторов

Если подходящих операторов нет (все неактивны, все на лимите, или ни один не настроен для источника), обращение создаётся **без назначения оператора** (`operator_id = null`). Это позволяет системе отслеживать все входящие обращения даже при отсутствии доступных операторов.
